"use strict";var spotifyService=function(){function a(b,c){log("SpotifyService: _getAllPlaylists");var d=c||{},e=d.deferred||Q.defer(),f=d.playlist||{},g=d.url||h+"/users/"+b+"/playlists?limit=50&offest=0";return $.ajax(g,i).then(function(c){if(c.items.forEach(function(a){f[a.id]={name:a.name,id:a.id,total:a.tracks.total,owner:a.owner.id}}),c.next)a(b,{playlist:f,url:c.next,deferred:e});else{var d=[];for(var g in f)d.push(f[g]);e.resolve({obj:f,arr:d})}},function(){e.reject(new Error("Unable to get playlists"))}),e.promise}function b(a){log.groupCollapsed("_normaliseTrackData");var b=[],c=function(a){for(var b=[],c=0;c<a.length;c++)b.push(a[c].name);return b.join(", ")};return a.forEach(function(a){a.track.preview_url?b.push({artist:{name:c(a.track.artists),id:a.track.artists[0].id},track:{name:a.track.name,url:a.track.preview_url,id:a.track.id}}):log("preview_url missing for "+a.track.name)}),log.groupEnd(),b}function c(a,c,d){log("SpotifyService: _getTracks");var e=Q.defer(),f=100,g=d||0,j=5,k=0,l="",m=[],n=[];f>g&&(j=1),log.groupCollapsed("playlist calls");for(var o=0;j>o;o++)k=f>=g?0:Math.floor(Math.random()*(g-f)),l=h+"/users/"+a+"/playlists/"+c+"/tracks?limit="+f+"&offset="+k,log(l),m.push($.ajax(l,i));return log.groupEnd(),Q.all(m).then(function(a){var c=0;a.forEach(function(a){c=a.total,n=n.concat(a.items)});var d=b(n),f=Helpers.shuffle(d);e.resolve({tracks:f,total:c})},function(a){console.error("error"),e.reject(a)}),e.promise}function d(a){return log("SpotifyService: _getUser"),i={headers:{Authorization:"Bearer "+a}},$.ajax(h+"/me",i)}function e(a){log("SpotifyService: _getSearchParams");var b=0===a.indexOf("?")?a.slice(1).split("&"):a.split("&"),c={};return b.forEach(function(a){var b=a.split("=");c[b[0]]=b[1]}),{access_token:c.access_token,refresh_token:c.refresh_token}}function f(a){var b=e(a);return{accessToken:b.access_token,refreshToken:b.refresh_token}}function g(a){var b="";if(a.indexOf("spotify:user")>-1){var c=a.split(":");5===c.length&&(b={owner:c[2],id:c[4]})}else if(a.indexOf("http://open.spotify.com/user/")>-1){var c=a.split("/");7===c.length&&(b={owner:c[4],id:c[6]})}return b}var h="https://api.spotify.com/v1",i={};return{login:function(){return $.ajax("api/login",{refresh:!0})},getTracks:function(a,b){return c(a,b).then(function(d){return c(a,b,d.total)},function(){console.error("error - _getPlaylistInfo")})},getAllPlaylists:a,getTokens:f,getUser:d,getUrl:g}}();